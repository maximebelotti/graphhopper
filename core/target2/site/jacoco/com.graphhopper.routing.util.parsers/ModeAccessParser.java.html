<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModeAccessParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GraphHopper Core</a> &gt; <a href="index.source.html" class="el_package">com.graphhopper.routing.util.parsers</a> &gt; <span class="el_source">ModeAccessParser.java</span></div><h1>ModeAccessParser.java</h1><pre class="source lang-java linenums">package com.graphhopper.routing.util.parsers;

import com.graphhopper.reader.ReaderWay;
import com.graphhopper.routing.ev.BooleanEncodedValue;
import com.graphhopper.routing.ev.EdgeIntAccess;
import com.graphhopper.routing.util.FerrySpeedCalculator;
import com.graphhopper.storage.IntsRef;

import java.util.List;
import java.util.Map;
import java.util.Set;

import static com.graphhopper.routing.util.parsers.OSMTemporalAccessParser.hasPermissiveTemporalRestriction;

public class ModeAccessParser implements TagParser {

<span class="fc" id="L17">    private static final Set&lt;String&gt; CAR_BARRIERS = Set.of(&quot;kissing_gate&quot;, &quot;fence&quot;,</span>
            &quot;bollard&quot;, &quot;stile&quot;, &quot;turnstile&quot;, &quot;cycle_barrier&quot;, &quot;motorcycle_barrier&quot;, &quot;block&quot;,
            &quot;bus_trap&quot;, &quot;sump_buster&quot;, &quot;jersey_barrier&quot;);
<span class="fc" id="L20">    private static final Set&lt;String&gt; INTENDED = Set.of(&quot;yes&quot;, &quot;designated&quot;, &quot;official&quot;, &quot;permissive&quot;, &quot;private&quot;, &quot;permit&quot;);</span>
<span class="fc" id="L21">    private static final Set&lt;String&gt; ONEWAYS_FW = Set.of(&quot;yes&quot;, &quot;true&quot;, &quot;1&quot;);</span>
    private final Set&lt;String&gt; restrictedValues;
    private final List&lt;String&gt; restrictionKeys;
    private final List&lt;String&gt; vehicleForward;
    private final List&lt;String&gt; vehicleBackward;
    private final List&lt;String&gt; ignoreOnewayKeys;
    private final BooleanEncodedValue accessEnc;
    private final BooleanEncodedValue roundaboutEnc;
    private final boolean skipEmergency;
    private final Set&lt;String&gt; barriers;

    public ModeAccessParser(List&lt;String&gt; restrictionKeys, BooleanEncodedValue accessEnc,
                            boolean skipEmergency, BooleanEncodedValue roundaboutEnc,
<span class="fc" id="L34">                            Set&lt;String&gt; restrictions, Set&lt;String&gt; barriers) {</span>
<span class="fc" id="L35">        this.accessEnc = accessEnc;</span>
<span class="fc" id="L36">        this.roundaboutEnc = roundaboutEnc;</span>
<span class="fc" id="L37">        this.restrictionKeys = restrictionKeys;</span>
<span class="fc" id="L38">        vehicleForward = restrictionKeys.stream().map(r -&gt; r + &quot;:forward&quot;).toList();</span>
<span class="fc" id="L39">        vehicleBackward = restrictionKeys.stream().map(r -&gt; r + &quot;:backward&quot;).toList();</span>
<span class="fc" id="L40">        ignoreOnewayKeys = restrictionKeys.stream().map(r -&gt; &quot;oneway:&quot; + r).toList();</span>
<span class="pc bpc" id="L41" title="1 of 2 branches missed.">        restrictedValues = restrictions.isEmpty() ? Set.of(&quot;no&quot;, &quot;restricted&quot;, &quot;military&quot;, &quot;emergency&quot;) : restrictions;</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">        this.barriers = barriers.isEmpty() ? CAR_BARRIERS : barriers;</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if (restrictedValues.contains(&quot;&quot;))</span>
<span class="nc" id="L44">            throw new IllegalArgumentException(&quot;restriction values cannot contain empty string&quot;);</span>
<span class="fc" id="L45">        this.skipEmergency = skipEmergency;</span>
<span class="fc" id="L46">    }</span>

    @Override
    public void handleWayTags(int edgeId, EdgeIntAccess edgeIntAccess, ReaderWay way, IntsRef relationFlags) {
<span class="fc" id="L50">        String highwayValue = way.getTag(&quot;highway&quot;);</span>
<span class="pc bpc" id="L51" title="4 of 6 branches missed.">        if (skipEmergency &amp;&amp; &quot;service&quot;.equals(highwayValue) &amp;&amp; &quot;emergency_access&quot;.equals(way.getTag(&quot;service&quot;)))</span>
<span class="nc" id="L52">            return;</span>

<span class="fc" id="L54">        int firstIndex = way.getFirstIndex(restrictionKeys);</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">        String firstValue = firstIndex &lt; 0 ? &quot;&quot; : way.getTag(restrictionKeys.get(firstIndex), &quot;&quot;);</span>
<span class="fc bfc" id="L56" title="All 4 branches covered.">        if (restrictedValues.contains(firstValue) &amp;&amp; !hasPermissiveTemporalRestriction(way, firstIndex, restrictionKeys, INTENDED))</span>
<span class="fc" id="L57">            return;</span>

<span class="pc bpc" id="L59" title="1 of 4 branches missed.">        if (way.hasTag(&quot;gh:barrier_edge&quot;) &amp;&amp; way.hasTag(&quot;node_tags&quot;)) {</span>
<span class="fc" id="L60">            List&lt;Map&lt;String, Object&gt;&gt; nodeTags = way.getTag(&quot;node_tags&quot;, null);</span>
<span class="fc" id="L61">            Map&lt;String, Object&gt; firstNodeTags = nodeTags.get(0);</span>
            // a barrier edge has the restriction in both nodes and the tags are the same -&gt; get(0)
<span class="fc" id="L63">            firstValue = getFirstPriorityNodeTag(firstNodeTags, restrictionKeys);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">            String barrierValue = firstNodeTags.containsKey(&quot;barrier&quot;) ? (String) firstNodeTags.get(&quot;barrier&quot;) : &quot;&quot;;</span>
<span class="fc bfc" id="L65" title="All 4 branches covered.">            if (restrictedValues.contains(firstValue) || barriers.contains(barrierValue)</span>
<span class="pc bpc" id="L66" title="3 of 4 branches missed.">                    || &quot;yes&quot;.equals(firstNodeTags.get(&quot;locked&quot;)) &amp;&amp; !INTENDED.contains(firstValue))</span>
<span class="fc" id="L67">                return;</span>
        }

<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (FerrySpeedCalculator.isFerry(way)) {</span>
<span class="nc" id="L71">            boolean isCar = restrictionKeys.contains(&quot;motorcar&quot;);</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">            if (INTENDED.contains(firstValue)</span>
                    // implied default is allowed only if foot and bicycle is not specified:
<span class="nc bnc" id="L74" title="All 8 branches missed.">                    || isCar &amp;&amp; firstValue.isEmpty() &amp;&amp; !way.hasTag(&quot;foot&quot;) &amp;&amp; !way.hasTag(&quot;bicycle&quot;)</span>
                    // if hgv is allowed then smaller trucks and cars are allowed too even if not specified
<span class="nc bnc" id="L76" title="All 2 branches missed.">                    || isCar &amp;&amp; way.hasTag(&quot;hgv&quot;, &quot;yes&quot;)) {</span>
<span class="nc" id="L77">                accessEnc.setBool(false, edgeId, edgeIntAccess, true);</span>
<span class="nc" id="L78">                accessEnc.setBool(true, edgeId, edgeIntAccess, true);</span>
            }
<span class="nc" id="L80">        } else {</span>
<span class="fc" id="L81">            boolean isRoundabout = roundaboutEnc.getBool(false, edgeId, edgeIntAccess);</span>
<span class="fc" id="L82">            boolean ignoreOneway = &quot;no&quot;.equals(way.getFirstValue(ignoreOnewayKeys));</span>
<span class="fc" id="L83">            boolean isBwd = isBackwardOneway(way);</span>
<span class="pc bpc" id="L84" title="1 of 8 branches missed.">            if (!ignoreOneway &amp;&amp; (isBwd || isRoundabout || isForwardOneway(way))) {</span>
<span class="fc" id="L85">                accessEnc.setBool(isBwd, edgeId, edgeIntAccess, true);</span>
            } else {
<span class="fc" id="L87">                accessEnc.setBool(false, edgeId, edgeIntAccess, true);</span>
<span class="fc" id="L88">                accessEnc.setBool(true, edgeId, edgeIntAccess, true);</span>
            }
        }
<span class="fc" id="L91">    }</span>

    private static String getFirstPriorityNodeTag(Map&lt;String, Object&gt; nodeTags, List&lt;String&gt; restrictionKeys) {
<span class="fc bfc" id="L94" title="All 2 branches covered.">        for (String key : restrictionKeys) {</span>
<span class="fc" id="L95">            String val = (String) nodeTags.get(key);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">            if (val != null) return val;</span>
<span class="fc" id="L97">        }</span>
<span class="fc" id="L98">        return &quot;&quot;;</span>
    }

    protected boolean isBackwardOneway(ReaderWay way) {
        // vehicle:forward=no is like oneway=-1
<span class="pc bpc" id="L103" title="1 of 4 branches missed.">        return way.hasTag(&quot;oneway&quot;, &quot;-1&quot;) || &quot;no&quot;.equals(way.getFirstValue(vehicleForward));</span>
    }

    protected boolean isForwardOneway(ReaderWay way) {
        // vehicle:backward=no is like oneway=yes
<span class="fc bfc" id="L108" title="All 4 branches covered.">        return way.hasTag(&quot;oneway&quot;, ONEWAYS_FW) || &quot;no&quot;.equals(way.getFirstValue(vehicleBackward));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>